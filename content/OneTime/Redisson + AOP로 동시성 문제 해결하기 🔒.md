---
date: 2025-06-08
tags:
  - onetime
  - backend
  - side-project
---

---

# ğŸš¨ ë¬¸ì œ ìƒí™©

11ê°œì›”ì§¸ ìš´ì˜ì¤‘ì¸, [ë‹¤ì¸ì› ì¼ì •ì¡°ìœ¨ ì›¹ì„œë¹„ìŠ¤ OneTime](https://www.onetime-with-members.com/)ì—ì„œëŠ” ì•¡ì„¸ìŠ¤ & ë¦¬í”„ë ˆì‰¬ í† í°ì„ ì•„ë˜ì™€ ê°™ì´ ê´€ë¦¬í•˜ê³  ìˆë‹¤.

> 1. ë¡œê·¸ì¸ ì‹œ, ìœ ì €ì˜ ì•¡ì„¸ìŠ¤ & ë¦¬í”„ë ˆì‰¬ í† í°ì„ ë°˜í™˜í•œë‹¤.
2. í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë³´ê´€ í›„, í•„ìš” ì‹œì— ì¬ë°œí–‰ ìš”ì²­ì„ í•œë‹¤.
	 - ìš”ì²­ ì‹œì—ëŠ” ë¦¬í”„ë ˆì‰¬ í† í°ì„ ë‹´ì•„ì„œ ë³´ë‚¸ë‹¤.
3. ì„œë²„ì—ì„œëŠ” ë°›ì€ ë¦¬í”„ë ˆì‰¬ í† í°ì´ ìœ ì € idì™€ ë™ì¼í•œì§€ & ë ˆë””ìŠ¤ì— ìˆëŠ” í† í°ê³¼ ë™ì¼í•œì§€ ê²€ì¦í•œë‹¤.
4. ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆë‹¤ë©´, **ì•¡ì„¸ìŠ¤ & ë¦¬í”„ë ˆì‰¬ í† í° ëª¨ë‘ ì¬ë°œí–‰í•˜ì—¬ ë°˜í™˜í•œë‹¤.**
	- ë¦¬í”„ë ˆì‰¬ í† í°ê¹Œì§€ ì¬ë°œí–‰ í•˜ëŠ” ì´ìœ ëŠ”, [í† í° íƒˆì·¨ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ê³ ë ¤](https://mgyo.tistory.com/832#google_vignette)í•œ ê²ƒì´ë‹¤.
    - ë¬¼ë¡  ê·¸ë ‡ë‹¤ê³  ëª¨ë“  ê²½ìš°ì— ëŒ€í•´ì„œ ì•ˆì „í•  ìˆ˜ëŠ” ì—†ë‹¤. 
5. ê²€ì¦ì— ì‹¤íŒ¨í•˜ëŠ” ë“± ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ê²½ìš°ì—ëŠ”, **401 ì—ëŸ¬ë¥¼ ì‘ë‹µí•˜ì—¬ ì¬ë¡œê·¸ì¸**í•˜ë„ë¡ í•œë‹¤.
6. í˜„ì¬ëŠ” `ìœ ì €id + ë¸Œë¼ìš°ì €id`ë¥¼ ë³µí•©í‚¤ë¡œ ë‘ì—ˆê³ , ì´ 5ê°œì˜ ì¡°í•©ì„ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.
	- ì¦‰, **ìœ ì € 1ëª… ë‹¹ 5ê°œì˜ ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì† ë° ë¡œê·¸ì¸ ìœ ì§€ê°€ ê°€ëŠ¥í•œ ìƒíƒœ**ì´ë‹¤.
    
ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ë¶€ë¶„ì€ 4ë²ˆìœ¼ë¡œ, í˜„ì¬ëŠ” ë¦¬í”„ë ˆì‰¬ í† í°ê¹Œì§€ í•¨ê»˜ ì¬ë°œí–‰í•˜ë¯€ë¡œ ì¬ì‚¬ìš©ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.

ë•Œë¬¸ì— ì´ì „ì— ì‚¬ìš©í•œ ë¦¬í”„ë ˆì‰¬ í† í°ìœ¼ë¡œ ìš”ì²­ì„ ë³´ë‚´ëŠ” ê²½ìš°ì—ëŠ”, 401 ì—ëŸ¬ ì‘ë‹µì„ í•˜ê²Œ ë˜ê³  ìœ ì €ëŠ” ì¬ë¡œê·¸ì¸ì„ í•´ì•¼ í•œë‹¤.

## ë™ì‹œì„± ë¬¸ì œ

ì–¸ì œë¶€í„°ì¸ê°€ ì›íƒ€ì„ì—ì„œ ë¡œê·¸ì¸ì´ í•œ ë²ˆì”© í’€ë¦¬ëŠ” ê²½ìš°ê°€ ë°œìƒí–ˆë‹¤. ë§¤ë²ˆ ê·¸ëŸ° ê²ƒì€ ì•„ë‹ˆì—ˆê¸°ì— ëŒ€ìˆ˜ë¡­ì§€ ì•Šê²Œ ì—¬ê²¼ìœ¼ë‚˜, ìµœê·¼ ê´€ë ¨ ë¡œì§ì„ ê±´ë“¤ê²Œ ë˜ë©´ì„œ ë¬¸ì œê°€ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œê²Œ ë˜ì—ˆë‹¤.

```bash
2025-06-05T01:18:35.210+09:00  INFO 1 --- [nio-8090-exec-8] s.o.g.interceptor.LoggingInterceptor     : ğŸ“¦ [POST] /api/v1/tokens/action-reissue 
body : {
  "refresh_token" : "..."
}
2025-06-05T01:18:35.231+09:00  INFO 1 --- [nio-8090-exec-8] s.o.g.interceptor.LoggingInterceptor     : âœ… [POST] /api/v1/tokens/action-reissue request completed - 21ms | status=201
2025-06-05T01:18:35.907+09:00  INFO 1 --- [io-8090-exec-10] s.o.g.interceptor.LoggingInterceptor     : âœ… [GET] /api/v1/users/profile request completed - 6ms | status=200
2025-06-05T01:18:35.964+09:00  INFO 1 --- [nio-8090-exec-9] s.o.g.interceptor.LoggingInterceptor     : ğŸ“¦ [POST] /api/v1/tokens/action-reissue 
body : {
  "refresh_token" : "..."
}
2025-06-05T01:18:35.968+09:00 ERROR 1 --- [nio-8090-exec-9] s.o.exception.GlobalExceptionHandler     : CustomException: ë¦¬í”„ë ˆì‰¬ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
2025-06-05T01:18:35.969+09:00 ERROR 1 --- [nio-8090-exec-9] s.o.g.interceptor.LoggingInterceptor     : âŒ [POST] /api/v1/tokens/action-reissue request failed - 5ms | status=401
```

ìœ„ ë¡œê·¸ë¥¼ ë³´ê²Œ ë˜ë©´, ê±°ì˜ ë™ì¼í•œ ì‹œì ì— ì¬ë°œí–‰ ìš”ì²­ì„ ë³´ë‚¸ë‹¤. í˜„ì¬ ë¦¬í”„ë ˆì‰¬ í† í°ì€ ë§ˆìŠ¤í‚¹í•˜ì˜€ì§€ë§Œ, **ë™ì¼í•œ ë¦¬í”„ë ˆì‰¬ í† í°ìœ¼ë¡œ ìš”ì²­ì´ ë“¤ì–´ì˜¨ ìƒí™©ì´ë‹¤.**

ë•Œë¬¸ì— ì²« ë²ˆì§¸ ìš”ì²­ì— ëŒ€í•´ì„œëŠ” ì •ìƒì ìœ¼ë¡œ 201 ì²˜ë¦¬ë˜ì—ˆì§€ë§Œ, ë‘ ë²ˆì§¸ ìš”ì²­ì— ëŒ€í•´ì„œëŠ” 401 ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤.

ë¬¸ì œ ìƒí™©ì„ ì •ë¦¬í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

> 1. ë™ì‹œì— A, B ìš”ì²­ì´ ë“¤ì–´ì˜¨ë‹¤.
2. Aì—ì„œ ë³´ë‚¸ ë¦¬í”„ë ˆì‰¬ í† í°ê³¼, ë ˆë””ìŠ¤ì— ì €ì¥ëœ ë¦¬í”„ë ˆì‰¬ í† í°ì´ ë™ì¼í•˜ë‹¤. ë•Œë¬¸ì— ì •ìƒì ìœ¼ë¡œ ì¬ë°œí–‰ë˜ê³  201ì„ ì‘ë‹µí•œë‹¤.
3. 2ë²ˆ ê³¼ì •ì—ì„œ ì¬ë°œí–‰ëœ ë¦¬í”„ë ˆì‰¬ í† í°ì´ ë ˆë””ìŠ¤ì— ìƒˆë¡­ê²Œ ì €ì¥ëœë‹¤.
4. Bì—ì„œ ë³´ë‚¸ ë¦¬í”„ë ˆì‰¬ í† í°(Aì—ì„œ ë³´ë‚¸ ê²ƒê³¼ ê°™ìŒ)ê³¼, ë ˆë””ìŠ¤ì— ì €ì¥ëœ ë¦¬í”„ë ˆì‰¬ í† í°ì„ ë¹„êµí•œë‹¤. **í•˜ì§€ë§Œ ì´ë¯¸ ì¬ë°œí–‰ë˜ì–´ ìƒˆë¡­ê²Œ ì €ì¥ë˜ì—ˆê¸°ì— ë™ì¼í•˜ì§€ ì•Šë‹¤.**
5. ë•Œë¬¸ì— B ìš”ì²­ì— ëŒ€í•´ì„œëŠ” `"ë¦¬í”„ë ˆì‰¬ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."` 401 ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ê²Œ ë˜ê³ , ìœ ì €ì˜ ë¡œê·¸ì¸ ìƒíƒœê°€ í’€ë¦°ë‹¤.

ë§Œì•½ Aì—ì„œ ìƒˆë¡œìš´ ë¦¬í”„ë ˆì‰¬ í† í°ì„ ì €ì¥í•˜ê¸° ì „ì—, Bì—ì„œ ë ˆë””ìŠ¤ì— ìˆëŠ” ë¦¬í”„ë ˆì‰¬ í† í°ì„ ì´ë¯¸ ì¡°íšŒí–ˆë‹¤ë©´ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šì•˜ì„ ê²ƒì´ë‹¤. ì´ëŸ¬í•œ ë¶€ë¶„ ë•Œë¬¸ì— í•­ìƒ ë¡œê·¸ì¸ì´ í’€ë¦¬ì§€ëŠ” ì•Šì•˜ë˜ ê²ƒ ê°™ë‹¤.

ìœ ì €ì˜ ë¡œê·¸ì¸ ìœ ì§€ëŠ” ì‚¬ìš©ì„± ë¶€ë¶„ì—ì„œ ì¤‘ìš”í•œ ë¶€ë¶„ì´ê¸°ì—, ì„œë²„ì—ì„œë„ ì•ˆì „ì„±ì„ ë³´ì¥í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤ê³  íŒë‹¨í•˜ì˜€ê³  **ì´ë¥¼ ìœ„í•´ ë¶„ì‚° ë½ì„ ë„ì…í•˜ê²Œ ë˜ì—ˆë‹¤.**

---

# ğŸ”’ ë¶„ì‚° ë½

## ë¶„ì‚° ë½(Distributed Lock)ì´ë€?

`ë¶„ì‚° ë½` ì€ ë©€í‹° ì„œë²„ í™˜ê²½ì—ì„œ ê³µìœ  ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ë™ì‹œ ì ‘ê·¼ì„ ì œì–´í•˜ê¸° ìœ„í•œ ë™ê¸°í™” ë©”ì»¤ë‹ˆì¦˜ì´ë‹¤.
 
ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ì—ì„œëŠ” `synchronized, ReentrantLock`ê³¼ ê°™ì€ JVM ìˆ˜ì¤€ì˜ ë½ì„ í™œìš©í•  ìˆ˜ ìˆì§€ë§Œ, ì—¬ëŸ¬ ì„œë²„ê°€ ë™ì‹œì— ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” í™˜ê²½ì—ì„œëŠ” í”„ë¡œì„¸ìŠ¤ ê°„ ìì›ì„ ì œì–´í•  ìˆ˜ë‹¨ì´ í•„ìš”í•˜ë‹¤.

> **íŠ¹ì§•**
- ë½ì˜ ì†Œìœ  ì—¬ë¶€ë¥¼ `Redis`ë‚˜ `ZooKeeper` ê°™ì€ ì¤‘ì•™ ì €ì¥ì†Œë¥¼ í†µí•´ ê´€ë¦¬í•œë‹¤.
- ë™ì‹œì— í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ë§Œ ë½ ì†Œìœ ê°€ ê°€ëŠ¥í•˜ë‹¤.
- ì¼ì • ì‹œê°„ í›„ ìë™ í•´ì œë˜ë„ë¡ TTL (lease time)ë“±ì˜ ì„¤ì •ì´ ê°€ëŠ¥í•˜ë‹¤.

> **ì£¼ìš” ì‚¬ìš© ì‚¬ë¡€**
- ê²°ì œ/ì£¼ë¬¸ ì‹œìŠ¤í…œì—ì„œ ì¤‘ë³µ ê²°ì œ ë°©ì§€
- ë‹¨ì¼ ìì›ì— ëŒ€í•œ ë™ì‹œ ë³€ê²½ ì œì–´
- ë™ì¼ ìì›ì„ ì¡°ì‘í•˜ëŠ” ë°°ì¹˜ ì‘ì—…ì—ì„œì˜ ì¶©ëŒ ë°©ì§€

### ì‚¬ìš© ì´ìœ 

ê·¸ëŸ¬ë‚˜ í˜„ì¬ OneTimeì€ ë‹¨ì¼ ì„œë²„ë¡œ ìš´ì˜ì¤‘ì´ê¸°ì—, `ë¶„ì‚° ë½ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì ì ˆí•œê°€?` ë¼ëŠ” ì˜ë¬¸ì´ ë“¤ ìˆ˜ ìˆë‹¤.

ê³ ë¯¼ ëì— ì•„ë˜ì™€ ê°™ì€ ì´ìœ ë¡œ ë¶„ì‚° ë½ ì‚¬ìš©ì„ ê²°ì •í•˜ì˜€ë‹¤.

> 1. ë¦¬í”„ë ˆì‰¬ í† í°ì„ ì €ì¥í•˜ê³  ìˆëŠ” RedisëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ì´ê¸° ë•Œë¬¸ì—, synchronized ê°™ì€ JVM ë‚´ë¶€ ë½ìœ¼ë¡œëŠ” Redis ìƒíƒœë¥¼ ë³´ì¥í•  ìˆ˜ ì—†ë‹¤. ë˜í•œ ë½ì´ í’€ë¦° ìˆœê°„ ì™¸ë¶€ ì ‘ê·¼ì´ ë™ì‹œì— ë°œìƒí•  ìˆ˜ ìˆì–´ ì •í•©ì„± ë³´ì¥ì´ ì–´ë µë‹¤.

> 2. í–¥í›„ ì„œë²„ê°€ ì—¬ëŸ¬ ëŒ€ë¡œ í™•ì¥ë˜ë”ë¼ë„, Redis ê¸°ë°˜ ë¶„ì‚° ë½ì€ í™•ì¥ì„±ê³¼ ì•ˆì •ì„±ì„ ìœ ì§€í•  ìˆ˜ ìˆë‹¤.

ë¶„ì‚° ë½ì„ êµ¬í˜„í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ë‹¤ì–‘í•˜ì§€ë§Œ, ê·¸ ì¤‘ì—ì„œë„ `Redisson`ì„ íƒí•˜ê²Œ ë˜ì—ˆë‹¤.

## Redissonì´ë€?

`Redisson`ì€ **Java ê¸°ë°˜ì˜ Redis í´ë¼ì´ì–¸íŠ¸**ë¡œ, Redisë¥¼ ì´ìš©í•œ `ë¶„ì‚° ë½, ìºì‹œ, ì„¸ì…˜, í` ë“±ì˜ ê³ ê¸‰ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ë‹¤.

Redissonì€ `Redis`ë¥¼ í™œìš©í•´ì„œ **ì—¬ëŸ¬ ìŠ¤ë ˆë“œ / ì—¬ëŸ¬ ì„œë²„ì—ì„œ ë™ì‹œì— ì ‘ê·¼í•˜ëŠ” ìƒí™©ì—ì„œë„ ë½ì„ ì œì–´**í•  ìˆ˜ ìˆë‹¤.

### Redisson ğŸ†š Lettuce

ë¶„ì‚° ë½ êµ¬í˜„ ì‹œ ìì£¼ ì‚¬ìš©ë˜ëŠ” ë‘ ìŠ¤íƒì„ ë¹„êµí•´ ë³´ìë©´ ì•„ë˜ì™€ ê°™ë‹¤.

| í•­ëª© | **Redisson** | **Lettuce** |
|------|--------------|-------------|
| **ë½ êµ¬í˜„ ë°©ì‹** | ë‚´ì¥ëœ ê³ ìˆ˜ì¤€ ë½ êµ¬í˜„ ì œê³µ (Fair Lock, ReentrantLock ë“±) | ê¸°ë³¸ Redis ëª…ë ¹ì–´ ê¸°ë°˜ (`SETNX`, `EXPIRE`)ìœ¼ë¡œ ì§ì ‘ êµ¬í˜„ í•„ìš” |
| **ë½ ì†Œìœ ì ì‹ë³„** | `lock.unlock()` ì‹œ ë½ ì†Œìœ ì ì—¬ë¶€ í™•ì¸ ê°€ëŠ¥ | ê¸°ë³¸ APIì—ì„œëŠ” ì†Œìœ ì í™•ì¸ ê¸°ëŠ¥ ì—†ìŒ |
| **ìë™ ë§Œë£Œ (TTL)** | `leaseTime` ì„¤ì •ìœ¼ë¡œ ìë™ í•´ì œ ê°€ëŠ¥ | `EXPIRE` ëª…ì‹œì  ì„¤ì • í•„ìš”, ëˆ„ë½ ì‹œ ì§€ì†ë  ìˆ˜ ìˆìŒ |
| **ì¬ì‹œë„ ë¡œì§** | `tryLock()` ë“±ì—ì„œ ë‚´ë¶€ ì¬ì‹œë„, ëŒ€ê¸° ì‹œê°„ í¬í•¨ (ìŠ¤í•€ë½ ì•„ë‹˜) | ì¬ì‹œë„ ë¡œì§ ì§ì ‘ êµ¬í˜„ í•„ìš” (`while` ë£¨í”„ + ë°±ì˜¤í”„ ë“±) |
| **ì˜ˆì™¸ ìƒí™© ì²˜ë¦¬** | ë½ ì†Œìœ  ì—¬ë¶€ ê²€ì¦ ë° ìë™ í•´ì œë¡œ ë³µêµ¬ì— ìœ ë¦¬ | ì˜ˆì™¸ ìƒí™© ì‹œ í•´ì œ ëˆ„ë½ì´ë‚˜ ì¶©ëŒ ê°€ëŠ¥ì„± ê³ ë ¤ í•„ìš” |
| **API ì‚¬ìš©ì„±** | ê³ ìˆ˜ì¤€ API ì œê³µìœ¼ë¡œ ê°„ê²°í•œ ì½”ë“œ ì‘ì„± ê°€ëŠ¥ | Redis ëª…ë ¹ ì¡°í•© ìœ„ì£¼ë¡œ ìœ ì—°í•˜ì§€ë§Œ ìƒëŒ€ì ìœ¼ë¡œ ë³µì¡ |
| **ì í•©í•œ ìƒí™©** | ë¶„ì‚° ë½, ì„¸ì…˜, í ë“± ê³ ê¸‰ ë™ê¸°í™” ê¸°ëŠ¥ì´ í•„ìš”í•œ ê²½ìš° | ë¹„ë™ê¸° ì²˜ë¦¬ë‚˜ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì´ í•„ìš”í•œ ê²½ìš°, ìºì‹œ ì¤‘ì‹¬ êµ¬ì¡° |

> **ğŸ’¡ ìŠ¤í•€ ë½(Spin Lock)ì´ë€?**
>
ìŠ¤í•€ ë½ì€ ë½ì„ íšë“í•  ë•Œê¹Œì§€ ë°˜ë³µì ìœ¼ë¡œ ë½ ìƒíƒœë¥¼ í™•ì¸í•˜ë©° ê¸°ë‹¤ë¦¬ëŠ” ë½ ë°©ì‹ì´ë‹¤. ì¦‰, ë½ì´ í•´ì œë  ë•Œê¹Œì§€ ê³„ì† ë£¨í”„ë¥¼ ëŒë©°(lockì´ í’€ë¦´ ë•Œê¹Œì§€ spin) ëŒ€ê¸°í•œë‹¤.

[ì°¸ê³ í•œ ë¸”ë¡œê·¸](https://yeees.tistory.com/473)

### ì™œ Redissonì´ ë” ì í•©í•œê°€?

> 1. ì¬ì‹œë„ ë¡œì§ì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ê¸° ë•Œë¬¸ì— `ìŠ¤í•€ë½` ì—†ì´ íš¨ìœ¨ì ìœ¼ë¡œ ì´ìš©í•  ìˆ˜ ìˆë‹¤.

> 2. TTL ê¸°ë°˜ ìë™ í•´ì œ ê¸°ëŠ¥ì´ ìˆê¸° ë•Œë¬¸ì—, ë½ì´ ë¬´ê¸°í•œ ìœ ì§€ë  ì¼ì´ ì—†ë‹¤.

> 3. Lettuceì— ë¹„í•´ì„œ ì¶”ìƒí™”ê°€ ë§ì´ ë˜ì–´ ìˆê¸°ì—, API ì‚¬ìš©ì´ ì‰½ê³  ê°„ê²°í•˜ë‹¤. ë•Œë¬¸ì— ì‹¤ìˆ˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆê³ , ìœ ì§€ë³´ìˆ˜ê°€ ìš©ì´í•˜ë‹¤.

> 4. ë³´ì•ˆ ë¯¼ê°í•œ Refresh Token ì²˜ë¦¬ì— ì•ˆì „ì„±ì„ í™•ë³´í•  ìˆ˜ ìˆë‹¤.

ì •ë¦¬í•˜ìë©´ í˜„ì¬ ë¦¬í”„ë ˆì‹œ í† í° ê°±ì‹  ì‹œ Redis ê¸°ë°˜ ë½ì´ í•„ìš”í•˜ê³ , ë™ì‹œì— `ì•ˆì „ì„± / ì˜ˆì™¸ ë³µì›`ì´ ì¤‘ìš”í•œ ìƒí™©ì´ë¯€ë¡œ, ì§ì ‘ ë½ì„ êµ¬í˜„í•´ì•¼ í•˜ëŠ” `Lettuce`ë³´ë‹¤ `Redisson`ì´ ë” ì í•©í•˜ë‹¤ê³  íŒë‹¨í•˜ì˜€ë‹¤.

## Redisson ë¶„ì‚° ë½ êµ¬í˜„ ê³¼ì •

### Redisson ì˜ì¡´ì„± ì¶”ê°€

```java
// Redisson
implementation 'org.redisson:redisson-spring-boot-starter:3.46.0'
```

### RedissonConfig

```java
import org.redisson.Redisson;
import org.redisson.api.RedissonClient;
import org.redisson.config.Config;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class RedissonConfig {

    @Value("${spring.data.redis.host}")
    private String redisHost;

    @Value("${spring.data.redis.port}")
    private int redisPort;

    private static final String REDISSON_HOST_PREFIX = "redis://";

    @Bean
    public RedissonClient redissonClient() {
        Config config = new Config();
        config.useSingleServer()
                .setAddress(REDISSON_HOST_PREFIX + redisHost + ":" + redisPort)
                .setConnectionMinimumIdleSize(1)
                .setConnectionPoolSize(64)
                .setConnectTimeout(3000)
                .setTimeout(3000)
                .setRetryAttempts(3)
                .setRetryInterval(1500);
        return Redisson.create(config);
    }
}

```

| ì˜µì…˜                          | ì„¤ëª…                                                   |
|-----------------------------|--------------------------------------------------------|
| `setAddress()`              | Redis ì£¼ì†Œ ì§€ì • (`redis://host:port`)                   |
| `setConnectionMinimumIdleSize()` | ìµœì†Œ ìœ íœ´ ì»¤ë„¥ì…˜ ìˆ˜ (í•­ìƒ ìœ ì§€í•  ì»¤ë„¥ì…˜ ìˆ˜)              |
| `setConnectionPoolSize()`       | ìµœëŒ€ ì»¤ë„¥ì…˜ í’€ í¬ê¸° (ë™ì‹œ ìš”ì²­ ì²˜ë¦¬ ìˆ˜ìš© ë²”ìœ„)           |
| `setConnectTimeout()`           | Redis ì„œë²„ ì—°ê²° ì‹œë„ íƒ€ì„ì•„ì›ƒ(ms)                        |
| `setTimeout()`                  | Redis ëª…ë ¹ ì²˜ë¦¬ íƒ€ì„ì•„ì›ƒ(ms)                             |
| `setRetryAttempts()`            | ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ íšŸìˆ˜                                     |
| `setRetryInterval()`            | ì¬ì‹œë„ ê°„ê²©(ms)                                        |

---

# â¬‡ï¸ AOP

ì—¬ê¸°ê¹Œì§€ `Redisson`ì— ëŒ€í•œ ê¸°ë³¸ ì„¤ì •ì€ ë§ˆì³¤ë‹¤.
ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ, **ê³µí†µ ê´€ì‹¬ì‚¬ë¥¼ ë¶„ë¦¬í•˜ê¸° ìœ„í•´ AOPë¥¼ ì ìš©**í•´ë³´ê¸°ë¡œ ê²°ì •í–ˆë‹¤.

## AOPë€?

![](https://velog.velcdn.com/images/hsh111366/post/d7a1e89d-18be-4d4b-b55f-59bb65b68180/image.png)


> `AOP(Aspect Oriented Programming, ê´€ì  ì§€í–¥ í”„ë¡œê·¸ë˜ë°)`ëŠ”
**ê³µí†µ ë¡œì§ì„ í•µì‹¬ ë¡œì§ê³¼ ë¶„ë¦¬í•´ì„œ ê´€ë¦¬í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê°œë…**ì´ë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, `ë¡œê¹…, íŠ¸ëœì­ì…˜, ì¸ì¦, ë¶„ì‚° ë½` ê°™ì€ ê¸°ëŠ¥ë“¤ì€ ì—¬ëŸ¬ í´ë˜ìŠ¤ì— ê±¸ì³ ë°˜ë³µë˜ê¸° ì‰½ê³ , **í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ì„ì´ë©´ ì½”ë“œê°€ ì§€ì €ë¶„**í•´ì§ˆ ìˆ˜ ìˆë‹¤.

AOPëŠ” ì´ëŸ° ë¡œì§ë“¤ì„ í•µì‹¬ ë¡œì§ê³¼ ë¶„ë¦¬í•´ì„œ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤€ë‹¤.

## ì„ ì • ì´ìœ 

í˜„ì¬ëŠ” ì¬ë°œí–‰ ë©”ì„œë“œì—ë§Œ ë½ ê´€ë ¨ ë¡œì§ì„ ì¶”ê°€í•˜ê² ì§€ë§Œ, ì¶”í›„ ëŠ˜ì–´ë‚  ìˆ˜ ìˆëŠ” ì—¬ì§€ê°€ ìˆë‹¤.

ë•Œë¬¸ì— ëª¨ë“  ë©”ì„œë“œì— ì§ì ‘ ë½ì„ ì¡ê³  í•´ì œí•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ê±´ ìœ ì§€ë³´ìˆ˜ë‚˜ í™•ì¥ì„± ë©´ì—ì„œ ì¢‹ì§€ ì•Šë‹¤ê³  íŒë‹¨í–ˆë‹¤.

ì•„ë˜ì—ì„œ ìì„¸íˆ ë‚˜ì˜¤ê² ì§€ë§Œ, AOPë¥¼ ì ìš©í•œë‹¤ë©´ ë½ì„ ì‚¬ìš©í•  ë©”ì„œë“œì— ë‹¨ìˆœíˆ `@DistributedLock` ê°™ì€ ì–´ë…¸í…Œì´ì…˜ë§Œ ë¶™ì—¬ ì ìš©í•  ìˆ˜ ìˆê¸°ì— ì‹¤ìš©ì ì´ë‹¤.

## êµ¬í˜„ ê³¼ì •

### DistributedLock ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜

```java
import java.lang.annotation.*;
import java.util.concurrent.TimeUnit;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface DistributedLock {
    String prefix();
    String key();
    long waitTime() default 3L;
    long leaseTime() default 2L;
    TimeUnit timeUnit() default TimeUnit.SECONDS;
}

```

Redisson ê¸°ë°˜ ë¶„ì‚° ë½ì„ ì ìš©í•˜ê¸° ìœ„í•œ `AOP ì–´ë…¸í…Œì´ì…˜`ì´ë‹¤.

ì´ ì–´ë…¸í…Œì´ì…˜ì€ `@Aspect`ë¡œ êµ¬ì„±ëœ AOP í´ë˜ìŠ¤ì—ì„œ íŒŒì‹±ë˜ì–´ Redissonì˜ `tryLock()` ë“±ì— ì ìš©ë˜ëŠ” êµ¬ì¡°ë¡œ í™œìš©ëœë‹¤.

| ì†ì„±ëª…       | ì„¤ëª…                                                                 | ê¸°ë³¸ê°’             |
|--------------|----------------------------------------------------------------------|--------------------|
| `prefix`     | ë½ í‚¤ì˜ ì ‘ë‘ì‚¬. ì„œë¹„ìŠ¤ ë„ë©”ì¸ êµ¬ë¶„ ë“±ì„ ìœ„í•´ ì‚¬ìš©ë¨                 | default ì—†ìœ¼ë¯€ë¡œ í•„ìˆ˜             |
| `key`        | ë½ì„ ê±¸ê¸° ìœ„í•œ ê³ ìœ  ì‹ë³„ì (ex. ì‚¬ìš©ì ID, ìš”ì²­ ID ë“±)               | default ì—†ìœ¼ë¯€ë¡œ í•„ìˆ˜             |
| `waitTime`   | ë½ íšë“ì„ ìœ„í•´ ê¸°ë‹¤ë¦¬ëŠ” ìµœëŒ€ ì‹œê°„                                   | `3L`               |
| `leaseTime`  | ë½ì„ íšë“í•œ ë’¤ ìë™ í•´ì œê¹Œì§€ì˜ ì‹œê°„                                  | `2L`               |
| `timeUnit`   | `waitTime`, `leaseTime`ì— ëŒ€í•œ ì‹œê°„ ë‹¨ìœ„                             | `TimeUnit.SECONDS` |

### CustomSpringELParser

```java
import lombok.RequiredArgsConstructor;
import org.springframework.core.DefaultParameterNameDiscoverer;
import org.springframework.expression.EvaluationContext;
import org.springframework.expression.spel.standard.SpelExpressionParser;
import org.springframework.expression.spel.support.StandardEvaluationContext;

import java.lang.reflect.Method;

@RequiredArgsConstructor
public class CustomSpringELParser {

    private final SpelExpressionParser parser = new SpelExpressionParser();
    private final DefaultParameterNameDiscoverer nameDiscoverer = new DefaultParameterNameDiscoverer();

    public String getDynamicValue(Method method, Object[] args, String expression) {
        EvaluationContext context = new StandardEvaluationContext();
        String[] paramNames = nameDiscoverer.getParameterNames(method);

        if (paramNames != null) {
            for (int i = 0; i < paramNames.length; i++) {
                context.setVariable(paramNames[i], args[i]);
            }
        }

        return parser.parseExpression(expression).getValue(context, String.class);
    }
}

```

`CustomSpringELParser`ëŠ” ë©”ì„œë“œì— ì „ë‹¬ëœ íŒŒë¼ë¯¸í„° ê°’ì„ `SpEL(Spring Expression Language)` í˜•ì‹ìœ¼ë¡œ ë™ì ìœ¼ë¡œ í•´ì„í•´ `ë½ í‚¤`ë¥¼ ìƒì„±í•˜ëŠ” ìœ í‹¸ í´ë˜ìŠ¤ì´ë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ `@DistributedLock(key = "#userId")`ì²˜ëŸ¼ ì‘ì„±í•˜ë©´, AOP ë‚´ë¶€ì—ì„œ `userId` **íŒŒë¼ë¯¸í„°ì˜ ì‹¤ì œ ê°’ì„ ì¶”ì¶œí•´ ë½ í‚¤ì— ì‚¬ìš©**í•  ìˆ˜ ìˆë‹¤.
`#dto.name`ì²˜ëŸ¼ ê°ì²´ ë‚´ë¶€ í•„ë“œë„ ì ‘ê·¼ ê°€ëŠ¥í•˜ë©°, ëŸ°íƒ€ì„ì— ë™ì ìœ¼ë¡œ í‰ê°€ëœë‹¤.

ì´ë¥¼ í†µí•´ ë©”ì„œë“œë§ˆë‹¤ ìœ ì—°í•˜ê³  êµ¬ì²´ì ì¸ ë½ í‚¤ë¥¼ ì§€ì •í•  ìˆ˜ ìˆê²Œ ëœë‹¤.

### DistributedLockAop

```java
package side.onetime.global.lock.aop;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.reflect.MethodSignature;
import org.redisson.api.RLock;
import org.redisson.api.RedissonClient;
import org.springframework.stereotype.Component;
import side.onetime.exception.CustomException;
import side.onetime.exception.status.TokenErrorStatus;
import side.onetime.global.lock.annotation.DistributedLock;
import side.onetime.global.lock.util.CustomSpringELParser;

@Slf4j
@Aspect
@Component
@RequiredArgsConstructor
public class DistributedLockAop {

    private final RedissonClient redissonClient;
    private final CustomSpringELParser parser = new CustomSpringELParser();

    @Around("@annotation(lock)")
    public Object lock(ProceedingJoinPoint joinPoint, DistributedLock lock) throws Throwable {
        MethodSignature signature = (MethodSignature) joinPoint.getSignature();
        String dynamicKey = parser.getDynamicValue(signature.getMethod(), joinPoint.getArgs(), lock.key());
        String lockName = lock.prefix() + ":" + dynamicKey;

        RLock rLock = redissonClient.getLock(lockName);
        boolean available = false;

        try {
            available = rLock.tryLock(lock.waitTime(), lock.leaseTime(), lock.timeUnit());
            if (!available) {
                throw new CustomException(TokenErrorStatus._TOO_MANY_REQUESTS);
            }

            log.debug("ğŸ” ë½ íšë“: {}", lockName);
            return joinPoint.proceed();
        } finally {
            if (available && rLock.isHeldByCurrentThread()) {
                rLock.unlock();
                log.debug("ğŸ”“ ë½ í•´ì œ: {}", lockName);
            }
        }
    }
}

```

`DistributedLockAop`ëŠ” `@DistributedLock` ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì€ **ë©”ì„œë“œì— AOP ë°©ì‹ìœ¼ë¡œ Redisson ê¸°ë°˜ì˜ ë¶„ì‚° ë½ì„ ì ìš©í•´ì£¼ëŠ” í´ë˜ìŠ¤**ì´ë‹¤.

ë™ì‘ ê³¼ì •ì€ ì•„ë˜ì™€ ê°™ë‹¤.


> **1. @Around("@annotation(lock)")**
`@DistributedLock`ì´ ë¶™ì€ ë©”ì„œë“œ ì‹¤í–‰ ì „í›„ì— í•´ë‹¹ AOPê°€ ì‘ë™í•œë‹¤.

> **2. parser.getDynamicValue(...)**
`SpEL`ì„ ì´ìš©í•´ ë½ í‚¤ë¡œ ì‚¬ìš©í•  ë™ì  ê°’ì„ ì¶”ì¶œí•œë‹¤.

> **3. rLock.tryLock(...)**
`waitTime` ë™ì•ˆ ë½ì„ ê¸°ë‹¤ë¦¬ê³ , `leaseTime` ë™ì•ˆ ìœ ì§€í•œë‹¤. ë½ íšë“ ì‹¤íŒ¨ ì‹œ ì»¤ìŠ¤í…€ ì˜ˆì™¸ë¥¼ ë°œìƒí•œë‹¤.

> **4. rLock.unlock()**
ë½ì„ í˜„ì¬ ìŠ¤ë ˆë“œê°€ ê°€ì§€ê³  ìˆë‹¤ë©´ í•´ì œí•œë‹¤.

### íŒ¨í‚¤ì§€ êµ¬ì¡°

![](https://velog.velcdn.com/images/hsh111366/post/834f5891-97b8-42c8-9362-a65a761ff646/image.png)

### AopForTransaction

```java
@Component
public class AopForTransaction {

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public Object proceed(final ProceedingJoinPoint joinPoint) throws Throwable {
        return joinPoint.proceed();
    }
}

```

`AopForTransaction`ì€ ë½ì´ ê±¸ë¦° ë¡œì§ì—ì„œ íŠ¸ëœì­ì…˜ì„ ë¶„ë¦¬ ì‹¤í–‰í•  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

`@Transactional(REQUIRES_NEW)`ë¡œ **í•­ìƒ ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê²Œ í•˜ì—¬, íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì´í›„ì— ë½ì´ í•´ì œë˜ë„ë¡ ë³´ì¥**í•œë‹¤.

í˜„ì¬ëŠ” íŠ¸ëœì­ì…˜ì´ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ë¡œì§ì— ë½ì„ ì¶”ê°€í•˜ì˜€ê¸°ì— í•„ìš” ì—†ì§€ë§Œ, **ì¶”í›„ DB ì‘ì—…ì´ ì¶”ê°€ë˜ë©´ ìœ„ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ì—¬ ë°ì´í„° ì •í•©ì„±ì„ ë³´ì¥**í•´ì•¼ í•  ê²ƒì´ë‹¤.

### ë©”ì„œë“œì— ì ìš©í•˜ê¸°

```java
   @DistributedLock(prefix = "lock:reissue", key = "#reissueTokenRequest.refreshToken", waitTime = 0)
    public ReissueTokenResponse reissueToken(ReissueTokenRequest reissueTokenRequest) {
        String refreshToken = reissueTokenRequest.refreshToken();

        Long userId = jwtUtil.getClaimFromToken(refreshToken, "userId", Long.class);
        String browserId = jwtUtil.getClaimFromToken(refreshToken, "browserId", String.class);
        String existRefreshToken = refreshTokenRepository.findByUserIdAndBrowserId(userId, browserId)
                .orElseThrow(() -> new CustomException(TokenErrorStatus._NOT_FOUND_REFRESH_TOKEN));

        if (!existRefreshToken.equals(refreshToken)) {
            throw new CustomException(TokenErrorStatus._NOT_FOUND_REFRESH_TOKEN);
        }

        String newAccessToken = jwtUtil.generateAccessToken(userId, "USER");
        String newRefreshToken = jwtUtil.generateRefreshToken(userId, browserId);
        refreshTokenRepository.save(new RefreshToken(userId, browserId, newRefreshToken));

        return ReissueTokenResponse.of(newAccessToken, newRefreshToken);
    }
```

`@DistributedLock(prefix = "lock:reissue", key = "#reissueTokenRequest.refreshToken", waitTime = 0)` ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì„ìœ¼ë¡œì¨ í† í° ì¬ë°œí–‰ ë©”ì„œë“œì— ë¶„ì‚° ë½ì„ ì ìš©í•œ ëª¨ìŠµì´ë‹¤.

AOPë¥¼ í™œìš©í–ˆê¸°ì—, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì¶”ê°€ì ì¸ ì½”ë“œë¥¼ í¬í•¨í•˜ì§€ ì•Šê³ ë„ ê¹”ë”í•˜ê²Œ ë¶„ì‚° ë½ì„ ì ìš©í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤.

> 1. `refreshToken` ìì²´ë¥¼ ë½ì˜ keyë¡œ ì‚¬ìš©í•˜ì—¬, ë™ì¼í•œ í† í°ë‹¹ í•˜ë‚˜ì˜ ë½ë§Œ ìƒì„±ë˜ë„ë¡ í•˜ì˜€ë‹¤.

>2. `waitTime = 0`ìœ¼ë¡œ ì„¤ì •í•¨ìœ¼ë¡œì¨, ì´ë¯¸ ë‹¤ë¥¸ ìš”ì²­ì´ ë½ì„ ì¡ê³  ìˆìœ¼ë©´ ë°”ë¡œ ì‹¤íŒ¨ì‹œí‚¤ë„ë¡ ë§Œë“¤ì—ˆë‹¤.
>
í† í° ì¬ë°œí–‰ì€ í•œ ë²ˆë§Œ ì„±ê³µí•´ì•¼ í•˜ëŠ” ì‘ì—…ì´ë¼ ê¸°ë‹¤ë¦´ í•„ìš”ê°€ ì—†ìœ¼ë©°, ì¤‘ë³µ ìš”ì²­ì„ ê°•í•˜ê²Œ ë§‰ì•„ì•¼ í•˜ëŠ” ì¼€ì´ìŠ¤ì´ê¸°ì— ì´ë ‡ê²Œ ê²°ì •í•˜ì˜€ë‹¤.
>

### + 25.06.12 ë‚´ìš© ì¶”ê°€

í•˜ì§€ë§Œ ì™„ì „íˆ ë™ì¼í•œ íƒ€ì´ë°ì— ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì´ ì•„ë‹ˆê³ ì„œëŠ” 429 ì—ëŸ¬ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ì—ˆë‹¤. ë¬¸ì œê°€ ëœ ê±´ ì•„ë˜ì™€ ê°™ì€ ìƒí™©ì´ì—ˆë‹¤.

	1.	ì²« ë²ˆì§¸ ìš”ì²­ì´ ë½ì„ ì¡ê³  ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ëœ ë’¤ ë½ì„ í•´ì œí•œë‹¤.
	2.	ë‘ ë²ˆì§¸ ìš”ì²­ì´ ë½ì´ í•´ì œëœ ì´í›„ ë“¤ì–´ì˜¨ë‹¤.
	3.	ë½ì„ ì •ìƒì ìœ¼ë¡œ ì¡ì€ í›„ ë¡œì§ì„ ì²˜ë¦¬í•œë‹¤.
	4.	ì²« ë²ˆì§¸ ìš”ì²­ì—ì„œ ì´ë¯¸ ì´ì „ í† í°ì€ ì¬ë°œí–‰ë˜ì—ˆê³ , Redisì—ì„œëŠ” ì‚­ì œëœ ìƒíƒœì´ë‹¤.
	5.	ê²°êµ­ ë‘ ë²ˆì§¸ ìš”ì²­ì€ 401 ì—ëŸ¬ê°€ ë°œìƒí•´ ìœ ì €ëŠ” ì¬ë¡œê·¸ì¸ì„ í•´ì•¼ í•œë‹¤.

ì¦‰, **ìš”ì²­ì´ ì´ë¯¸ ì²˜ë¦¬ë˜ì–´ ë½ì´ í•´ì œëœ ì´í›„ì— ë“¤ì–´ì˜¤ëŠ” ë™ì¼ í† í° ìš”ì²­ì€ ë½ìœ¼ë¡œëŠ” ë§‰ì„ ìˆ˜ ì—†ì—ˆë‹¤.**

ì‚¬ì‹¤ **ë½ì˜ ëª©ì  ìì²´ê°€ ì¼ì • ì‹œê°„ ìš”ì²­ì„ ì œí•œí•˜ëŠ” ê²Œ ì•„ë‹ˆë¼, ë™ì‹œ ì ‘ê·¼ì— ë”°ë¥¸ ë°ì´í„° ì •í•©ì„± ë¬¸ì œë¥¼ ë°©ì§€í•˜ëŠ” ë° ì´ˆì **ì´ ë§ì¶°ì ¸ ìˆìœ¼ë‹ˆ ë‹¹ì—°í•œ ê²°ê³¼ì´ê¸°ë„ í•˜ë‹¤.

ê·¸ë˜ì„œ [`Redis Cooldown Key`](https://redis.io/kb/doc/19n37tc6g3/what-is-the-redis-enterprise-cooldown-feature) ë¥¼ í™œìš©í•´ì„œ, ë½ ì´í›„ì˜ ì§§ì€ ì‹œê°„ ë™ì•ˆ ì¤‘ë³µ ìš”ì²­ì„ ë§‰ì•„ë³´ì•˜ë‹¤.

> **RefreshTokenRepository**

```java
public boolean isInCooldown(Long userId, String browserId) {
    String key = COOLDOWN_PREFIX + userId + ":" + browserId;
    return Boolean.TRUE.equals(redisTemplate.hasKey(key));
}

public void setCooldown(Long userId, String browserId, long millis) {
    String key = COOLDOWN_PREFIX + userId + ":" + browserId;
    redisTemplate.opsForValue().set(key, "1", millis, TimeUnit.MILLISECONDS);
}
```

Redisì— `ì¿¨ë‹¤ìš´ í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë©”ì„œë“œì™€, í•´ë‹¹ í‚¤ë¥¼ ì¼ì • ì‹œê°„ ë™ì•ˆ ì„¤ì •í•˜ëŠ” ë©”ì„œë“œ`ë¥¼ ê°ê° ì¶”ê°€í–ˆë‹¤.

> **TokenService**

```java
@DistributedLock(prefix = "lock:reissue", key = "#reissueTokenRequest.refreshToken", waitTime = 0)
public ReissueTokenResponse reissueToken(ReissueTokenRequest reissueTokenRequest) {
    String refreshToken = reissueTokenRequest.refreshToken();

    Long userId = jwtUtil.getClaimFromToken(refreshToken, "userId", Long.class);
    String browserId = jwtUtil.getClaimFromToken(refreshToken, "browserId", String.class);

    // ì¿¨ë‹¤ìš´ ì²´í¬
    if (refreshTokenRepository.isInCooldown(userId, browserId)) {
        throw new CustomException(TokenErrorStatus._TOO_MANY_REQUESTS);
    }

    String existRefreshToken = refreshTokenRepository.findByUserIdAndBrowserId(userId, browserId)
        .orElseThrow(() -> new CustomException(TokenErrorStatus._NOT_FOUND_REFRESH_TOKEN));

    if (!existRefreshToken.equals(refreshToken)) {
        throw new CustomException(TokenErrorStatus._NOT_FOUND_REFRESH_TOKEN);
    }

    String newAccessToken = jwtUtil.generateAccessToken(userId, "USER");
    String newRefreshToken = jwtUtil.generateRefreshToken(userId, browserId);
    refreshTokenRepository.save(new RefreshToken(userId, browserId, newRefreshToken));

    // ì¿¨ë‹¤ìš´ ì„¤ì • (0.5ì´ˆ)
    refreshTokenRepository.setCooldown(userId, browserId, 500);

    return ReissueTokenResponse.of(newAccessToken, newRefreshToken);
}
```

ìš”ì²­ì´ ë“¤ì–´ì™”ì„ ë•Œ, ë¨¼ì € ì¿¨ë‹¤ìš´ í‚¤ ì¡´ì¬ ì—¬ë¶€ë¥¼ í™•ì¸í•´ì„œ **0.5ì´ˆ ì´ë‚´ ì¤‘ë³µ ìš”ì²­ì´ë©´ 429 ì—ëŸ¬ë¡œ ì°¨ë‹¨í•˜ê³ , ì •ìƒ ì²˜ë¦¬ëœ ê²½ìš°ì—ëŠ” ë¡œì§ ì¢…ë£Œ í›„ í•´ë‹¹ ì¿¨ë‹¤ìš´ í‚¤ë¥¼ Redisì— ì„¤ì •**í•œë‹¤.

> **ê²°ê³¼**

```bash
2025-06-12T20:11:11.277+09:00  INFO 1 --- [nio-8090-exec-8] s.o.g.interceptor.LoggingInterceptor     : ğŸ“¦ [POST] /api/v1/tokens/action-reissue 
body : {
  "refresh_token" : "...qaN_0"
}
2025-06-12T20:11:11.286+09:00  INFO 1 --- [nio-8090-exec-7] s.o.g.interceptor.LoggingInterceptor     : ğŸ“¦ [POST] /api/v1/tokens/action-reissue 
body : {
  "refresh_token" : "...qaN_0"
}
2025-06-12T20:11:11.297+09:00  INFO 1 --- [io-8090-exec-10] s.o.g.interceptor.LoggingInterceptor     : ğŸ“¦ [POST] /api/v1/tokens/action-reissue 
body : {
  "refresh_token" : "...qaN_0"
}
2025-06-12T20:11:11.331+09:00 ERROR 1 --- [io-8090-exec-10] s.o.exception.GlobalExceptionHandler     : CustomException: ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
2025-06-12T20:11:11.331+09:00 ERROR 1 --- [nio-8090-exec-7] s.o.exception.GlobalExceptionHandler     : CustomException: ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
2025-06-12T20:11:11.332+09:00  INFO 1 --- [nio-8090-exec-8] s.o.g.interceptor.LoggingInterceptor     : âœ… [POST] /api/v1/tokens/action-reissue request completed - 54ms | status=201
2025-06-12T20:11:11.337+09:00 ERROR 1 --- [io-8090-exec-10] s.o.g.interceptor.LoggingInterceptor     : âŒ [POST] /api/v1/tokens/action-reissue request failed - 39ms | status=429
2025-06-12T20:11:11.338+09:00 ERROR 1 --- [nio-8090-exec-7] s.o.g.interceptor.LoggingInterceptor     : âŒ [POST] /api/v1/tokens/action-reissue request failed - 52ms | status=429
```

ìœ„ ë°©ë²•ì„ ì ìš©í•˜ì—¬ ë¹ ë¥¸ ì‹œê°„ ë‚´ì— ì¤‘ë³µìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ ë§‰ì„ ìˆ˜ ìˆì—ˆë‹¤. 
ê²°ê³¼ì ìœ¼ë¡œëŠ” `ë¶„ì‚° ë½ + Redis Cooldown Key`ì˜ ì¡°í•©ìœ¼ë¡œ í† í° ì¬ë°œí–‰ ì‹œ ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•˜ê²Œ ë˜ì—ˆë‹¤.

---

# ğŸ“Š í…ŒìŠ¤íŠ¸

## í…ŒìŠ¤íŠ¸ í™˜ê²½

> **ëª©ì **
ë™ì¼í•œ ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ê²½ìš°, `@DistributedLock`ì´ ì œëŒ€ë¡œ ë™ì‘í•˜ì—¬ í•˜ë‚˜ë§Œ ì„±ê³µí•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ì‹¤íŒ¨(429) í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.

> **ì‚¬ìš© ë„êµ¬**
`Grafana K6`

> **ì‹œë‚˜ë¦¬ì˜¤**
1ëª…ì˜ ì‚¬ìš©ìê°€ ë™ì¼í•œ `refresh_token`ì„ ê°€ì§€ê³ , ë™ì‹œì— 10ê°œì˜ í† í° ì¬ë°œê¸‰ ìš”ì²­ì„ ë³‘ë ¬ë¡œ ë³´ë‚¸ë‹¤.

> **ê¸°ëŒ€ ê²°ê³¼**
ì˜¤ì§ 1ê°œì˜ ìš”ì²­ë§Œ 201(Created) ë¡œ ì„±ê³µí•˜ê³ , ë‚˜ë¨¸ì§€ 9ê°œëŠ” ë½ íšë“ ì‹¤íŒ¨ë¡œ ì¸í•´ 429(Too Many Requests) ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.
>
ìƒˆë¡œ ë°œê¸‰ëœ í† í°ì„ í™œìš©í•´ í›„ì† ë‹¨ì¼ ìš”ì²­ë„ ì„±ê³µ(201) í•´ì•¼ í•œë‹¤.

## í…ŒìŠ¤íŠ¸ ì½”ë“œ

```js
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  vus: 1,
  iterations: 1,
};

export default function () {
  const originalToken = '...'
  const url = 'http://localhost:8090/api/v1/tokens/action-reissue';
  const headers = { 'Content-Type': 'application/json' };
  const payload = JSON.stringify({ refresh_token: originalToken });

  const requests = Array.from({ length: 10 }, () => [
    'POST',
    url,
    payload,
    { headers },
  ]);

  const responses = http.batch(requests);

  let newRefreshToken = null;

  responses.forEach((res, i) => {
    const ok = check(res, {
      [`[Parallel ${i + 1}] Status is 201 or 429`]: (r) => r.status === 201 || r.status === 429,
    });

    if (res.status === 201) {
      const resBody = JSON.parse(res.body);
      newRefreshToken = resBody.payload.refresh_token;
      console.log(`[Parallel ${i + 1}] âœ… Success - New token: ${newRefreshToken}`);
    } else {
      console.error(`[Parallel ${i + 1}] âŒ Failed - Status: ${res.status}`);
    }
  });

  // ìƒˆ í† í°ì´ ìˆë‹¤ë©´ ë‹¨ì¼ ìš”ì²­ìœ¼ë¡œ ì¬í™•ì¸
  if (newRefreshToken) {
    const newPayload = JSON.stringify({ refresh_token: newRefreshToken });
    const res = http.post(url, newPayload, { headers });

    check(res, {
      '[Follow-up] Status is 201': (r) => r.status === 201,
    });

    console.log(`[Follow-up] Status: ${res.status}`);
  }
}

```

## ê²°ê³¼

### ê¸°ì¡´ ë¡œì§ : ë¶„ì‚° ë½ X

![](https://velog.velcdn.com/images/hsh111366/post/9a07fce5-f62c-45d2-a645-4057f6aea1e1/image.png)

- ì´ˆê¸° 6ê°œì˜ ìš”ì²­ì— ëŒ€í•´ì„œëŠ” ëª¨ë‘ 201 ì‘ë‹µì„ ë°›ì•˜ë‹¤. ì´ëŠ” ìƒˆë¡œìš´ ë¦¬í”„ë ˆì‰¬ í† í°ì´ ë ˆë””ìŠ¤ì— ì €ì¥ë˜ê¸° ì´ì „ì´ì—ˆê¸°ì— ì˜ˆì™¸ ì²˜ë¦¬ë˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤.
- í•˜ì§€ë§Œ ì´í›„ë¡œëŠ” ëª¨ë‘ 401 ì—ëŸ¬ ì‘ë‹µì„ ë°›ì•˜ë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ ì„±ê³µí•œ 6ë²ˆì§¸ ìš”ì²­ì—ì„œ ìƒˆë¡­ê²Œ ì €ì¥ëœ ë¦¬í”„ë ˆì‰¬ í† í°ê³¼, ì´í›„ 4ë²ˆì˜ ìš”ì²­ì—ì„œì˜ ë¦¬í”„ë ˆì‰¬ í† í°ì´ ë‹¤ë¥´ê¸° ë•Œë¬¸ì´ë‹¤.
- ë§ˆì§€ë§‰ìœ¼ë¡œ ì¬ìš”ì²­ í–ˆì„ ë•Œë„ ì •ìƒì ìœ¼ë¡œ 201 ì‘ë‹µì„ ë°›ì•˜ë‹¤. í—ˆë‚˜, ì´ë¯¸ ìœ ì €ëŠ” ì´ì „ì˜ 401 ì—ëŸ¬ ì‘ë‹µìœ¼ë¡œ ì¸í•´ì„œ ì¬ë¡œê·¸ì¸í•˜ëŠ” ìƒí™©ì´ ë°œìƒí•œë‹¤.

### ë³€ê²½ ë¡œì§ : ë¶„ì‚° ë½ O

![](https://velog.velcdn.com/images/hsh111366/post/3801abf4-c5a5-4d6a-b0af-2a743369ad6a/image.png)

```bash
2025-06-08T02:58:51.704+09:00 ERROR 19265 --- [nio-8090-exec-1] s.o.exception.GlobalExceptionHandler     : CustomException: ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
2025-06-08T02:58:51.704+09:00 ERROR 19265 --- [nio-8090-exec-6] s.o.exception.GlobalExceptionHandler     : CustomException: ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
2025-06-08T02:58:51.704+09:00 ERROR 19265 --- [nio-8090-exec-2] s.o.exception.GlobalExceptionHandler     : CustomException: ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
2025-06-08T02:58:51.704+09:00 ERROR 19265 --- [nio-8090-exec-3] s.o.exception.GlobalExceptionHandler     : CustomException: ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
2025-06-08T02:58:51.704+09:00 ERROR 19265 --- [nio-8090-exec-6] s.o.g.interceptor.LoggingInterceptor     : âŒ [POST] /api/v1/tokens/action-reissue request failed - 2ms | status=429
2025-06-08T02:58:51.704+09:00 ERROR 19265 --- [nio-8090-exec-1] s.o.g.interceptor.LoggingInterceptor     : âŒ [POST] /api/v1/tokens/action-reissue request failed - 1ms | status=429
2025-06-08T02:58:51.705+09:00 ERROR 19265 --- [nio-8090-exec-2] s.o.g.interceptor.LoggingInterceptor     : âŒ [POST] /api/v1/tokens/action-reissue request failed - 3ms | status=429
2025-06-08T02:58:51.705+09:00 ERROR 19265 --- [nio-8090-exec-3] s.o.g.interceptor.LoggingInterceptor     : âŒ [POST] /api/v1/tokens/action-reissue request failed - 2ms | status=429
2025-06-08T02:58:51.725+09:00  INFO 19265 --- [nio-8090-exec-7] s.o.g.interceptor.LoggingInterceptor     : âœ… [POST] /api/v1/tokens/action-reissue request completed - 99ms | status=201
2025-06-08T02:58:51.729+09:00  INFO 19265 --- [nio-8090-exec-4] s.o.g.interceptor.LoggingInterceptor     : ğŸ“¦ [POST] /api/v1/tokens/action-reissue 
body : {
  "refresh_token" : "..."
}
2025-06-08T02:58:51.736+09:00  INFO 19265 --- [nio-8090-exec-4] s.o.g.interceptor.LoggingInterceptor     : âœ… [POST] /api/v1/tokens/action-reissue request completed - 6ms | status=201
```

- 10ë²ˆì˜ ë³‘ë ¬ ìš”ì²­ ì¤‘ì—ì„œ, ë‹¨ 1ë²ˆì˜ ìš”ì²­ì— ëŒ€í•´ì„œë§Œ 201 ì‘ë‹µì„ ë°›ì•˜ë‹¤. ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ ë½ì„ íšë“í•˜ì§€ ëª» í•˜ì—¬ 429 ì—ëŸ¬ ì‘ë‹µì„ ë°›ëŠ”ë‹¤.
- ë§ˆì§€ë§‰ìœ¼ë¡œ ì¬ìš”ì²­ í–ˆì„ ë•Œ ì •ìƒì ìœ¼ë¡œ 201 ì‘ë‹µì„ ë°›ì•˜ë‹¤. ì´ì „ì— 401 ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì—, ìœ ì €ëŠ” ì¬ë¡œê·¸ì¸í•  í•„ìš”ê°€ ì—†ë‹¤.

> ğŸ§‘ğŸ»â€ğŸ’» í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ê¸°ëŒ€ëŒ€ë¡œ ì˜ ë‚˜ì™”ê³ , ê²°ê³¼ì ìœ¼ë¡œ ì´ë¥¼ ì ìš©í•˜ì—¬ ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì—ˆë‹¤!
>
ps. í•˜ì§€ë§Œ ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í–ˆë‹¤ê³  í•´ì„œ ê·¼ë³¸ì ì¸ ë¬¸ì œê°€ í•´ê²°ë˜ì§€ëŠ” ì•ŠëŠ”ë‹¤. **1ì°¨ì ì¸ ë¬¸ì œëŠ” í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ë™ì¼í•œ í† í°ìœ¼ë¡œ ì—¬ëŸ¬ ë²ˆ ìš”ì²­í•˜ëŠ” ê²ƒ**ì´ê¸°ì—, ì´ë¥¼ ìš°ì„ ì ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ìˆë„ë¡ í”„ë¡ íŠ¸ ê°œë°œìì™€ ì˜ ì†Œí†µí•˜ë„ë¡ í•˜ì.
>
[í”„ë¡ íŠ¸ì—ì„œ ì°¸ê³ í•˜ë©´ ì¢‹ì„ ê¸€ 1](https://velog.io/@eogns0321/token-refresh-ë™ì‹œì„±-ì´ìŠˆ)
[í”„ë¡ íŠ¸ì—ì„œ ì°¸ê³ í•˜ë©´ ì¢‹ì„ ê¸€ 2](https://jaeseo0519.tistory.com/405)

---

[ì°¸ê³ í•œ ë¸”ë¡œê·¸ 1](https://helloworld.kurly.com/blog/distributed-redisson-lock/)
[ì°¸ê³ í•œ ë¸”ë¡œê·¸ 2](https://velog.io/@meong/SpringBoot-Redisson-AOP-%EC%A0%81%EC%9A%A9%EA%B8%B0-%EC%9E%AC%EA%B3%A0-%EB%8F%99%EC%8B%9C%EC%84%B1-%EC%A0%9C%EC%96%B4)
